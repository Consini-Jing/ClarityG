The email contains a ZIP attachment that holds a PE32 executable.

The executable, written in .NET, functions as a downloader for the next stage of the infection chain.

When executed, the downloader reaches out to an IPFS gateway to retrieve a blob of data that has been hosted within the IPFS network as shown below.

This data contains an obfuscated PE32 executable that functions as the next-stage malware payload.

The downloader takes the data from the IPFS gateway and stores each byte in an array.

It then uses a key value stored in the executable to convert the byte array into the next-stage PE32.

This is then reflectively loaded and executed, launching the next stage of the infection process, which in this case is a remote access trojan (RAT) called Agent Tesla.

In all three clusters, the initial payload functioned as a loader and operated similarly, however, the final payload hosted on the IPFS network was different in each cluster.

In most cases, the loader was not packed, but we did observe samples packed using UPX.

When executed, the loader first creates a directory structure within %APPDATA% using the following command:

C:\Windows\system32\cmd.exe /c cd %appdata%\Microsoft && mkdir Network

The malware then attempts to retrieve Python 3.10 from the legitimate software provider using the cURL command.

The command line syntax used to initiate the download is shown below.

Once the ZIP archive has been retrieved, it is then unzipped into the directory that was previously created using the PowerShell "Expand-Archive" cmdlet.

C:\Windows\system32\cmd.exe /c cd %appdata%\Microsoft\Network && powershell Expand-Archive python-3.10.4-embed-amd64.zip -DestinationPath %appdata%\Microsoft\Network

The malware then attempts to retrieve the final payload in the infection chain, storing it within the Network directory using the filename "Packages.txt".

An example of the loader retrieving Hannabi Grabber, an information stealer written in Python is shown below.

The loader then uses the attrib.exe utility to set the System and Hidden flags on the previously created directory as well as the Python ZIP archive and final payload that was retrieved.

C:\Windows\system32\cmd.exe /c attrib +S +H %appdata%\Microsoft\Network

C:\Windows\system32\cmd.exe /c attrib +S +H %appdata%\Microsoft\Network\python-3.10.4-embed-amd64.zip

C:\Windows\system32\cmd.exe /c attrib +S +H %appdata%\Microsoft\Network\Packages.txt

Finally, the loader invokes the newly downloaded Python executable and passes the final payload as a command line argument, executing the next stage of the infection process.

C:\Windows\system32\cmd.exe /c cd %appdata%\Microsoft\Network && python.exe Packages.txt

In some cases, the malware was also observed achieving persistence via adding entries into the Windows registry at the following locations:

During our analysis of samples associated with this loader, we observed that the IPFS gateway that was being used was no longer servicing requests, however, Talos obtained the next-stage payloads manually via another IPFS gateways for analysis.

In one of the clusters leveraging this loader, we observed that the payload being hosted within the IPFS network was a Python script containing a large base64 encoded blob along with the Python code responsible for decoding the base64.

After decoding all of the layers, the following is the deobfuscated reverse shell payload.

At the time of analysis, the C2 server was no longer servicing requests on TCP/4444.

In another cluster we analyzed, we observed that the final payload hosted within IPFS was a Windows batch file, as shown below:

When the batch file is retrieved, it is stored within the Network directory using the filename "Script.bat".

Deleting volume shadow copies on the system.

Deleting directory contents stored within C:\Users (typically associated with user profiles).

Iterating through all mounted filesystems present on the system and deleting contents stored on them.

Fortunately for victims, in the samples analyzed the loader incorrectly attempts to invoke the batch file as shown below.

C:\Windows\system32\cmd.exe /c cd %appdata%\Microsoft\Network && powershell -Command start script.bat -Verb RunAs

The final cluster of malware associated with this loader is responsible for retrieving and executing a Python-based information stealer called Hannabi Grabber.

It leverages Discord Webhooks for C2 and data exfiltration.

It collects survey information from the infected machine, obtains the geographic location of the system via the IPInfo service, takes screenshots and eventually transmits that data to an attacker-controlled Discord server in JSON format.

In addition to the previously listed applications, the malware also supports retrieving password and cookie data from Chrome, as shown below.

Similar functionality also exists to target Mozilla Firefox browser data that may be present on the system.

The information stealer is particularly interested in Discord and Roblox data.

If discovered, the malware will attempt to bypass them to obtain Discord tokens from the victim.

Application data that is collected is stored within a directory structure inside of the %TEMP% directory, in a folder called "RedDiscord" that is created by the malware.

Before exfiltrating the data, the malware creates a ZIP archive within the RedDiscord directory called "Hannabi-<USERNAME>.zip".

The malware first transmits beacon information and will then attempt to exfiltrate the newly created ZIP archive.

Typically, attackers will attempt to leverage PyInstaller or Py2EXE to compile their Python into a PE32 file format prior to distributing it to victims.

This is a case where instead, the attacker chose to include a Python installation process during the infection and is leveraging Python directly to steal sensitive information from victims.

